<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ghost Cam Pro - GitHub Edition</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --accent: #fffc00; --bg: #000; }
        html, body { margin: 0; padding: 0; height: 100dvh; background: #000; color: #fff; font-family: -apple-system, sans-serif; overflow: hidden; }
        .app-layout { display: flex; flex-direction: column; height: 100dvh; width: 100vw; padding: 10px; box-sizing: border-box; gap: 10px; }
        #remote-wrapper { flex: 1; position: relative; background: #111; border-radius: 20px; border: 1px solid #333; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        #remote-video { width: 100%; height: 100%; object-fit: cover; }
        .side-panel { flex: 0 0 auto; display: flex; flex-direction: column; gap: 8px; }
        .mobile-top-row { display: flex; gap: 10px; height: 110px; align-items: center; }
        #local-wrapper { width: 140px; height: 100%; background: #000; border-radius: 15px; overflow: hidden; border: 1px solid #444; position: relative; }
        #local-video-preview { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        #local-canvas { position: absolute; inset: 0; width: 100%; height: 100%; opacity: 0; pointer-events: none; }
        .controls-wrap { flex: 1; display: flex; flex-direction: column; gap: 8px; }
        .btn-stack { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; }
        .action-btn { background: #222; color: white; border: 1px solid #333; padding: 12px 0; border-radius: 10px; cursor: pointer; font-size: 18px; }
        .action-btn.active { background: #ff4444 !important; }
        #resync-btn { background: var(--accent); color: #000; border: none; padding: 12px; border-radius: 10px; font-weight: 900; font-size: 12px; cursor: pointer; text-transform: uppercase; }
        .chat-box { height: 150px; display: flex; flex-direction: column; background: #0a0a0a; border: 1px solid #222; border-radius: 15px; overflow: hidden; }
        #chat-content { flex: 1; overflow-y: auto; padding: 10px; font-size: 12px; display: flex; flex-direction: column; gap: 5px; }
        .chat-input-area { display: flex; padding: 8px; background: #111; gap: 8px; border-top: 1px solid #222; }
        #message-input { flex: 1; background: #000; border: 1px solid #333; color: #fff; padding: 10px; border-radius: 8px; outline: none; }
        .msg.sys { color: var(--accent); font-weight: bold; font-size: 10px; }
        .msg.me { align-self: flex-end; background: #333; padding: 6px 12px; border-radius: 12px; }
        .msg.peer { align-self: flex-start; background: #222; padding: 6px 12px; border-radius: 12px; }
    </style>
</head>
<body>
<div class="app-layout">
    <div id="remote-wrapper"><video id="remote-video" autoplay playsinline muted></video></div>
    <div class="side-panel">
        <div class="mobile-top-row">
            <div id="local-wrapper">
                <video id="local-video-preview" autoplay playsinline muted></video>
                <canvas id="local-canvas"></canvas>
            </div>
            <div class="controls-wrap">
                <div class="btn-stack">
                    <button id="mic-btn" class="action-btn" onclick="toggleMic()">ðŸŽ¤</button>
                    <button id="blur-btn" class="action-btn" onclick="toggleBlur()">ðŸ”’</button>
                    <button class="action-btn" onclick="copyInviteLink()">ðŸ”—</button>
                    <button class="action-btn" onclick="location.reload()">ðŸ”„</button>
                </div>
                <button id="resync-btn" onclick="manualSync()">RE-SYNC CONNECTION</button>
            </div>
        </div>
        <div class="chat-box">
            <div id="chat-content"><div class="msg sys">STATUS: GITHUB DEPLOYMENT READY</div></div>
            <div class="chat-input-area">
                <input type="text" id="message-input" placeholder="WiadomoÅ›Ä‡..." onkeypress="if(event.key==='Enter')sendMessage()">
                <button onclick="sendMessage()" style="background:var(--accent); border:none; border-radius:8px; font-weight:bold; padding:0 15px; cursor:pointer;">OK</button>
            </div>
        </div>
    </div>
</div>
<script>
    if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
        location.replace(`https:${location.href.substring(location.protocol.length)}`);
    }

    const urlParams = new URLSearchParams(window.location.search);
    const mode = urlParams.get('mode');
    let roomID = window.location.hash.substring(1) || Math.random().toString(36).substring(2, 8);
    window.location.hash = roomID;

    let peer, conn, localStream, processedStream, isBlur = false, isMuted = false;
    const rVideo = document.getElementById('remote-video');
    const lVideo = document.getElementById('local-video-preview');
    const canvas = document.getElementById('local-canvas');
    const ctx = canvas.getContext('2d');

    function addMsg(text, type = 'sys') {
        const div = document.createElement('div');
        div.className = 'msg ' + type;
        div.innerText = type === 'sys' ? `[SYS]: ${text}` : text;
        const chat = document.getElementById('chat-content');
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
    }

    async function initApp() {
        try {
            localStream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "user", width: { ideal: 640 } }, 
                audio: true 
            });
            lVideo.srcObject = localStream;
            lVideo.onloadedmetadata = () => {
                canvas.width = lVideo.videoWidth;
                canvas.height = lVideo.videoHeight;
                drawLoop();
                processedStream = canvas.captureStream(25);
                localStream.getAudioTracks().forEach(t => processedStream.addTrack(t));
                startPeer();
            };
        } catch (e) { addMsg("Hardware Error: " + e.message, "sys"); }
    }

    function drawLoop() {
        ctx.save();
        ctx.translate(canvas.width, 0); ctx.scale(-1, 1);
        ctx.filter = isBlur ? 'blur(40px) grayscale(1)' : 'none';
        ctx.drawImage(lVideo, 0, 0, canvas.width, canvas.height);
        ctx.restore();
        requestAnimationFrame(drawLoop);
    }

    function startPeer() {
        peer = new Peer(mode === 'join' ? roomID + "_guest" : roomID, {
            config: { 'iceServers': [{ 'urls': 'stun:stun.l.google.com:19302' }, { 'urls': 'stun:stun1.l.google.com:19302' }] }
        });

        peer.on('open', id => {
            addMsg("P2P ONLINE. ROOM ID: " + roomID, "sys");
            if (mode === 'join') setTimeout(manualSync, 1000);
        });

        peer.on('call', call => {
            addMsg("INCOMING CALL...", "sys");
            call.answer(processedStream);
            handleCall(call);
        });

        peer.on('connection', c => handleChat(c));
    }

    function handleCall(call) {
        call.on('stream', s => {
            addMsg("STREAM RECEIVED", "sys");
            rVideo.srcObject = s;
            rVideo.play().catch(() => rVideo.onclick = () => rVideo.play());
        });
    }

    function handleChat(c) {
        conn = c;
        c.on('open', () => addMsg("CHAT READY", "sys"));
        c.on('data', data => addMsg(data, 'peer'));
    }

    function manualSync() {
        if (peer && processedStream && mode === 'join') {
            handleCall(peer.call(roomID, processedStream));
            handleChat(peer.connect(roomID, { reliable: true }));
        }
        addMsg("SYNCING...", "sys");
    }

    function sendMessage() {
        const input = document.getElementById('message-input');
        if (input.value && conn && conn.open) {
            conn.send(input.value);
            addMsg(input.value, 'me');
            input.value = '';
        }
    }

    function toggleBlur() { isBlur = !isBlur; document.getElementById('blur-btn').classList.toggle('active', isBlur); }
    function toggleMic() { isMuted = !isMuted; localStream.getAudioTracks().forEach(t => t.enabled = !isMuted); document.getElementById('mic-btn').classList.toggle('active', isMuted); }
    function copyInviteLink() { 
        const link = window.location.href.split('?')[0] + "?mode=join#" + roomID;
        navigator.clipboard.writeText(link).then(() => alert("Link Skopiowany!")); 
    }

    window.onload = initApp;
</script>
</body>
</html> 
