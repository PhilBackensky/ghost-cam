<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ghost Cam Pro - Final Fix</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --accent: #fffc00; --bg: #000; }
        html, body { margin: 0; padding: 0; height: 100dvh; background: #000; color: #fff; font-family: -apple-system, sans-serif; overflow: hidden; }
        #overlay-start { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .start-btn { background: var(--accent); color: #000; border: none; padding: 20px 40px; border-radius: 50px; font-weight: 900; font-size: 20px; cursor: pointer; }
        .app-layout { display: flex; flex-direction: column; height: 100dvh; width: 100vw; padding: 10px; box-sizing: border-box; gap: 10px; }
        #remote-wrapper { flex: 1; background: #111; border-radius: 20px; border: 1px solid #333; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        #remote-video { width: 100%; height: 100%; object-fit: cover; }
        .side-panel { flex: 0 0 auto; display: flex; flex-direction: column; gap: 8px; }
        #local-wrapper { width: 140px; height: 110px; background: #000; border-radius: 15px; overflow: hidden; border: 1px solid #444; position: relative; }
        #local-video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        .btn-stack { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-top: 5px; }
        .action-btn { background: #222; color: white; border: 1px solid #333; padding: 12px 0; border-radius: 10px; }
        #chat-content { height: 120px; overflow-y: auto; background: #0a0a0a; border: 1px solid #222; border-radius: 10px; padding: 8px; font-size: 11px; display: flex; flex-direction: column; gap: 4px; }
    </style>
</head>
<body>

<div id="overlay-start">
    <h1 style="color:var(--accent)">GHOST CAM</h1>
    <button class="start-btn" onclick="initApp()">START CAMERA</button>
</div>

<div class="app-layout">
    <div id="remote-wrapper"><video id="remote-video" autoplay playsinline muted></video></div>
    <div class="side-panel">
        <div style="display:flex; gap:10px; align-items:center;">
            <div id="local-wrapper"><video id="local-video" autoplay playsinline muted></video></div>
            <div style="flex:1">
                <div class="btn-stack">
                    <button class="action-btn" onclick="location.reload()">ðŸ”„</button>
                    <button class="action-btn" onclick="copyInviteLink()">ðŸ”—</button>
                    <button class="action-btn" onclick="manualSync()">âš¡</button>
                </div>
            </div>
        </div>
        <div id="chat-content"></div>
    </div>
</div>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const mode = urlParams.get('mode');
    let roomID = window.location.hash.substring(1) || Math.random().toString(36).substring(2, 8);
    window.location.hash = roomID;

    let peer, conn, localStream;
    const rVideo = document.getElementById('remote-video');
    const lVideo = document.getElementById('local-video');

    function addMsg(text) {
        const div = document.createElement('div');
        div.innerText = `[SYS]: ${text}`;
        document.getElementById('chat-content').appendChild(div);
    }

    async function initApp() {
        document.getElementById('overlay-start').style.display = 'none';
        try {
            localStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: true });
            lVideo.srcObject = localStream;
            startPeer();
        } catch (e) { alert("BÅ‚Ä…d kamery: " + e.message); }
    }

    function startPeer() {
        peer = new Peer(mode === 'join' ? roomID + "_guest" : roomID);
        peer.on('open', () => {
            addMsg("ONLINE. ID: " + roomID);
            if (mode === 'join') manualSync();
        });
        peer.on('call', call => {
            call.answer(localStream);
            call.on('stream', s => { rVideo.srcObject = s; rVideo.play(); });
        });
        peer.on('connection', c => {
            conn = c;
            c.on('data', data => addMsg("PEER: " + data));
        });
    }

    function manualSync() {
        if (!peer) return;
        const call = peer.call(roomID, localStream);
        call.on('stream', s => { rVideo.srcObject = s; rVideo.play(); });
        conn = peer.connect(roomID);
    }

    function copyInviteLink() {
        const link = window.location.origin + window.location.pathname + "?mode=join#" + roomID;
        navigator.clipboard.writeText(link).then(() => alert("Link skopiowany!"));
    }
</script>
</body>
</html>
